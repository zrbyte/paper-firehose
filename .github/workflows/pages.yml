name: Build and Deploy HTML

on:
  workflow_dispatch:
    inputs:
      purge_recent:
        description: "Purge entries from the last day before running the pipeline"
        required: false
        default: "false"
  # to enalble scheduled runs, uncomment the following lines
  # schedule:
  #   # Run every day at 4 AM UTC
  #   - cron: '0 5 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages-runtime-data
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PAPER_FIREHOSE_DATA_DIR: ${{ github.workspace }}/.paper_firehose
      CONFIG_PATH: ${{ github.workspace }}/.paper_firehose/config/config.yaml
      PURGE_RECENT: ${{ github.event.inputs.purge_recent || 'false' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache sentence transformer models
        uses: actions/cache@v3
        with:
          path: ~/.cache/huggingface/hub
          key: huggingface-models-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            huggingface-models-

      - name: Initialize data directory
        run: |
          set -euo pipefail
          mkdir -p "$PAPER_FIREHOSE_DATA_DIR"

      - name: Restore runtime databases cache
        id: cache-runtime-dbs
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.PAPER_FIREHOSE_DATA_DIR }}/all_feed_entries.db
            ${{ env.PAPER_FIREHOSE_DATA_DIR }}/matched_entries_history.db
            ${{ env.PAPER_FIREHOSE_DATA_DIR }}/papers.db
          key: runtime-dbs-${{ github.run_id }}
          restore-keys: |
            runtime-dbs-

      - name: Load databases from data branch
        run: |
          set -euo pipefail
          mkdir -p "$PAPER_FIREHOSE_DATA_DIR" assets

          if ls "$PAPER_FIREHOSE_DATA_DIR"/*.db >/dev/null 2>&1; then
            echo "âœ… Databases restored from cache; skipping data branch fetch"
            exit 0
          fi

          echo "=== Loading databases from data branch ==="
          if ! git ls-remote --exit-code --heads origin data >/dev/null 2>&1; then
            echo "â„¹ï¸  data branch not found; starting with empty databases"
            exit 0
          fi

          git fetch origin data
          git lfs install --local

          WT="$(mktemp -d)"
          cleanup() { git worktree remove -f "$WT" >/dev/null 2>&1 || rm -rf "$WT"; }
          trap cleanup EXIT

          git worktree add --detach "$WT" origin/data
          pushd "$WT" >/dev/null
            git lfs pull origin data || true
          popd >/dev/null

          load_db() {
            local remote_path="$1"
            local dest="$2"
            local label="$3"
            local source="$WT/${remote_path}"
            if [ -f "${source}" ]; then
              cp "${source}" "${dest}"
              echo "âœ… Loaded ${label} from data branch into ${dest}"
              ls -lh "${dest}"
            else
              echo "â„¹ï¸  ${label} not found in data branch; starting fresh"
              rm -f "${dest}"
            fi
          }

          load_db "assets/all_feed_entries.latest.db" "$PAPER_FIREHOSE_DATA_DIR/all_feed_entries.db" "all_feed_entries.db"
          load_db "assets/matched_entries_history.latest.db" "$PAPER_FIREHOSE_DATA_DIR/matched_entries_history.db" "matched_entries_history.db"
          load_db "assets/papers.latest.db" "$PAPER_FIREHOSE_DATA_DIR/papers.db" "papers.db"

          echo "=== Database loading complete ==="

      - name: Populate runtime config
        run: |
          set -euo pipefail

          CONFIG_SRC="$GITHUB_WORKSPACE/github_actions_config"
          CONFIG_DEST="$PAPER_FIREHOSE_DATA_DIR/config"

          if [ -d "$CONFIG_SRC" ]; then
            mkdir -p "$CONFIG_DEST"
            rsync -a --delete --exclude '.DS_Store' "$CONFIG_SRC"/ "$CONFIG_DEST"/
            echo "âœ… Copied workflow config from $CONFIG_SRC to $CONFIG_DEST"
          else
            echo "â„¹ï¸  github_actions_config directory not found; using defaults bundled with the package"
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .[docs]

      - name: Create secret files
        run: |
          set -euo pipefail
          mkdir -p "$PAPER_FIREHOSE_DATA_DIR/config/secrets"

          if [ -n "${{ secrets.SMTP_PASSWORD || '' }}" ]; then
            printf '%s' "${{ secrets.SMTP_PASSWORD }}" > "$PAPER_FIREHOSE_DATA_DIR/config/secrets/email_password.env"
            chmod 600 "$PAPER_FIREHOSE_DATA_DIR/config/secrets/email_password.env"
            echo "âœ… Wrote SMTP password file"
          else
            echo "â„¹ï¸  SMTP_PASSWORD secret not set; email step may fail"
          fi

          if [ -n "${{ secrets.MAILING_LISTS_YAML || '' }}" ]; then
            printf '%s\n' "${{ secrets.MAILING_LISTS_YAML }}" > "$PAPER_FIREHOSE_DATA_DIR/config/secrets/mailing_lists.yaml"
            chmod 600 "$PAPER_FIREHOSE_DATA_DIR/config/secrets/mailing_lists.yaml"
            echo "âœ… Wrote mailing_lists.yaml from secret"
          else
            echo "â„¹ï¸  MAILING_LISTS_YAML secret not set; falling back to default"
          fi

      - name: Purge recent entries
        if: ${{ env.PURGE_RECENT == 'true' }}
        run: |
          set -euo pipefail
          echo "=== Purging entries from the last day ==="
          paper-firehose --config "$CONFIG_PATH" purge --days 1
          echo "âœ… Purge completed"

      - name: Run paper firehose pipeline
        run: |
          set -euo pipefail

          echo "=== Starting Paper Firehose pipeline (runtime data dir) ==="
          echo "Data dir: $PAPER_FIREHOSE_DATA_DIR"

          ls -la "$PAPER_FIREHOSE_DATA_DIR" || true

          paper-firehose --config "$CONFIG_PATH" filter
          paper-firehose --config "$CONFIG_PATH" rank
          paper-firehose --config "$CONFIG_PATH" abstracts --mailto "github-actions@paper-firehose.com"

          echo "Step 4: Abstract summarization skipped"

          paper-firehose --config "$CONFIG_PATH" pqa_summary
          paper-firehose --config "$CONFIG_PATH" email

          paper-firehose --config "$CONFIG_PATH" html

          echo "âœ… Pipeline completed successfully"

          echo "Post-pipeline database state:"
          ls -lh "$PAPER_FIREHOSE_DATA_DIR"/*.db || true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Commit updated databases to data branch
        env:
          KEEP_SNAPSHOTS: "2"
          DB_HISTORY: ".paper_firehose/matched_entries_history.db"
          DB_SEEN: ".paper_firehose/all_feed_entries.db"
          DB_CURRENT: ".paper_firehose/papers.db"
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin --prune

          if ! git ls-remote --exit-code --heads origin data >/dev/null 2>&1; then
            git branch -f data HEAD
            git push -u origin data || true
          fi

          WT=/tmp/data-wt
          mkdir -p "$WT"
          git worktree add -B data "$WT" origin/data
          cleanup() { git worktree remove -f "$WT" || true; }
          trap cleanup EXIT

          pushd "$WT" >/dev/null
            git lfs install --local

            if [ -f "$GITHUB_WORKSPACE/.gitattributes" ]; then
              cp "$GITHUB_WORKSPACE/.gitattributes" .gitattributes
              git add .gitattributes
            fi

            mkdir -p assets
            TS="$(date -u +%Y%m%dT%H%M%SZ)"

            # Only keep latest + two previous versions
            update_db() {
              local src="$1"; local stem="$2"
              if [ -f "$GITHUB_WORKSPACE/$src" ]; then
                # Backup current .latest.db to .previous.db if it exists
                if [ -f "assets/${stem}.previous.db" ]; then
                  mv "assets/${stem}.previous.db" "assets/${stem}.previous2.db" || true
                fi
                if [ -f "assets/${stem}.latest.db" ]; then
                  mv "assets/${stem}.latest.db" "assets/${stem}.previous.db" || true
                fi
                # Copy new version as .latest.db
                cp "$GITHUB_WORKSPACE/$src" "assets/${stem}.latest.db"
                git add -f "assets/${stem}.latest.db" "assets/${stem}.previous.db" "assets/${stem}.previous2.db" 2>/dev/null || true
                echo "âœ… Updated ${stem}: latest + two previous versions retained"
              else
                echo "â„¹ï¸  Skip: $src not found"
              fi
            }

            update_db "$DB_HISTORY" "matched_entries_history"
            update_db "$DB_SEEN" "all_feed_entries"
            update_db "$DB_CURRENT" "papers"

            # Remove old snapshot directory if it exists
            if [ -d "assets/db_history" ]; then
              git rm -rf "assets/db_history" || rm -rf "assets/db_history"
              echo "ğŸ—‘ï¸  Removed historical snapshot directory"
            fi

            if ! git diff --cached --quiet; then
              git commit -m "Update databases @ ${TS} [skip ci]"
              git push origin data
              echo "âœ… Databases committed and pushed to data branch"
            else
              echo "â„¹ï¸  No changes to commit."
            fi
          popd >/dev/null

      - name: Save runtime databases cache
        if: ${{ success() }}
        uses: actions/cache/save@v3
        with:
          path: |
            ${{ env.PAPER_FIREHOSE_DATA_DIR }}/all_feed_entries.db
            ${{ env.PAPER_FIREHOSE_DATA_DIR }}/matched_entries_history.db
            ${{ env.PAPER_FIREHOSE_DATA_DIR }}/papers.db
          key: runtime-dbs-${{ github.run_id }}

      - name: Build documentation
        run: |
          set -euo pipefail
          sphinx-build -b html docs docs/_build/html

      - name: Prepare site
        run: |
          set -euo pipefail
          rm -rf site
          mkdir -p site
          if [ -d docs/_build/html ]; then
            cp -R docs/_build/html/. site/
          fi
          if [ -d "$PAPER_FIREHOSE_DATA_DIR/html" ]; then
            cp "$PAPER_FIREHOSE_DATA_DIR"/html/*.html site/ 2>/dev/null || true
            cp -r "$PAPER_FIREHOSE_DATA_DIR"/html site/html || true
          fi
          cp history_viewer*.html site/ 2>/dev/null || true
          touch site/.nojekyll

      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
